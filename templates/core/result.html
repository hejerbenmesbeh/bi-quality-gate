{% extends 'base.html' %}

{% block title %}R√©sultats - Quality Gate BI{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>{{ analyse.nom_fichier }}</h2>
            <div>
                <a href="{% url 'core:exporter' analyse.pk 'json' %}" class="btn btn-info btn-sm">
                    <i class="bi bi-download"></i> JSON
                </a>
                <a href="{% url 'core:detail' analyse.pk %}" class="btn btn-primary btn-sm">
                    <i class="bi bi-info-circle"></i> D√©tails
                </a>
                <a href="{% url 'core:historique' %}" class="btn btn-secondary btn-sm">
                    <i class="bi bi-arrow-left"></i> Retour
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Score -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card text-center">
            <div class="card-body py-5">
                <div class="score-circle {% if analyse.score >= 80 %}score-success{% elif analyse.score >= 60 %}score-warning{% else %}score-danger{% endif %}">
                    {{ analyse.score }}/100
                </div>
                <h5 class="mt-3">
                    {% if analyse.est_approuve %}
                        <span class="badge bg-success">‚úÖ APPROUV√â</span>
                    {% else %}
                        <span class="badge bg-danger">‚ùå REJET√â</span>
                    {% endif %}
                </h5>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5>Statistiques</h5>
                <table class="table table-sm">
                    <tr>
                        <td><strong>Langage:</strong></td>
                        <td><span class="badge bg-primary">{{ analyse.outil }}</span></td>
                    </tr>
                    <tr>
                        <td><strong>Probl√®mes totaux:</strong></td>
                        <td>{{ analyse.nb_problemes_total }}</td>
                    </tr>
                    <tr>
                        <td><strong>üî¥ Critiques:</strong></td>
                        <td><strong class="text-danger">{{ analyse.nb_critiques }}</strong></td>
                    </tr>
                    <tr>
                        <td><strong>üü† Warnings:</strong></td>
                        <td><strong class="text-warning">{{ analyse.nb_warnings }}</strong></td>
                    </tr>
                    <tr>
                        <td><strong>üîµ Info:</strong></td>
                        <td><strong class="text-info">{{ analyse.nb_infos }}</strong></td>
                    </tr>
                    <tr>
                        <td><strong>‚è±Ô∏è Temps analyse:</strong></td>
                        <td>{{ analyse.temps_analyse|floatformat:2 }}s</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Probl√®mes par source -->
<div class="row mb-4">
    <div class="col-12">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#par-source">
                    Par source ({{ analyse.problemes.count }})
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#par-severite">
                    Par s√©v√©rit√©
                </button>
            </li>
        </ul>
        
        <div class="tab-content">
            <!-- Par source -->
            <div id="par-source" class="tab-pane fade show active">
                {% for source, problemes in problemes_par_source.items %}
                    {% if problemes %}
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                {% if source == 'flake8' %}
                                    <span class="badge tool-flake8">Flake8</span> Style Python
                                {% elif source == 'bandit' %}
                                    <span class="badge tool-bandit">Bandit</span> S√©curit√©
                                {% elif source == 'openai' %}
                                    <span class="badge tool-openai">OpenAI</span> Analyse IA
                                {% elif source == 'manuel' %}
                                    <span class="badge tool-manuel">Manuel</span> R√®gles BI
                                {% endif %}
                                ({{ problemes.count }})
                            </h6>
                        </div>
                        <div class="card-body">
                            {% for probleme in problemes %}
                            <div class="problem-card problem-{{ probleme.severite }} mb-3 p-3">
                                <strong>{{ probleme.get_severite_icon }} {{ probleme.message }}</strong>
                                {% if probleme.ligne %}
                                    <br><small class="text-muted">Ligne {{ probleme.ligne }}</small>
                                {% endif %}
                                {% if probleme.suggestion %}
                                    <div class="mt-2 p-2 bg-light rounded">
                                        üí° <strong>Suggestion:</strong> {{ probleme.suggestion }}
                                    </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            
            <!-- Par s√©v√©rit√© -->
            <div id="par-severite" class="tab-pane fade">
                {% for severite, problemes in problemes_par_severite.items %}
                    {% if problemes %}
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                {% if severite == 'critique' %}
                                    üî¥ Critique ({{ problemes.count }})
                                {% elif severite == 'warning' %}
                                    üü† Warning ({{ problemes.count }})
                                {% else %}
                                    üîµ Info ({{ problemes.count }})
                                {% endif %}
                            </h6>
                        </div>
                        <div class="card-body">
                            {% for probleme in problemes %}
                            <div class="problem-card problem-{{ severite }} mb-3 p-3">
                                <strong>[{{ probleme.source|upper }}] {{ probleme.message }}</strong>
                                {% if probleme.suggestion %}
                                    <div class="mt-2 p-2 bg-light rounded">
                                        üí° {{ probleme.suggestion }}
                                    </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}