# ========================================
# Workflow Quality Gate BI
# ========================================
# Ce workflow analyse automatiquement le code Ã  chaque push
# et bloque les pull requests si le code ne respecte pas les standards

name: Quality Gate BI

# Quand lancer ce workflow
on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.py'
      - '**.sql'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.py'
      - '**.sql'

# Variables d'environnement
env:
  PYTHON_VERSION: '3.11'
  DJANGO_SETTINGS_MODULE: 'bi_quality_gate.settings'

jobs:
  # ==========================================
  # JOB 1: Analyse Python (Flake8 + Bandit)
  # ==========================================
  python-quality:
    name: Python Quality Check
    runs-on: ubuntu-latest
    
    steps:
      # RÃ©cupÃ©rer le code
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # RÃ©cupÃ¨re tout l'historique pour comparaison
      
      # Installer Python
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      # Installer les dÃ©pendances
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 bandit
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      # ExÃ©cuter Flake8
      - name: ğŸ“ Run Flake8
        run: |
          echo "ğŸ” Running Flake8..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics
        continue-on-error: false
      
      # ExÃ©cuter Bandit
      - name: ğŸ”’ Run Bandit
        run: |
          echo "ğŸ” Running Bandit..."
          bandit -r core/ -f json -o bandit-report.json || true
          bandit -r core/ -ll
        continue-on-error: false
      
      # Uploader les rapports
      - name: ğŸ“¤ Upload Bandit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json

  # ==========================================
  # JOB 2: Analyse ComplÃ¨te avec Quality Gate
  # ==========================================
  quality-gate-analysis:
    name: Full Quality Gate Analysis
    runs-on: ubuntu-latest
    needs: python-quality  # Attend que le job prÃ©cÃ©dent soit terminÃ©
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # CrÃ©er un fichier .env temporaire pour les tests
      - name: ğŸ”§ Create .env file
        run: |
          echo "DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}" > .env
          echo "DEBUG=False" >> .env
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
      
      # Lancer les migrations
      - name: ğŸ—„ï¸ Run migrations
        run: |
          python manage.py migrate --noinput
      
      # Analyser tous les fichiers Python modifiÃ©s
      - name: ğŸ” Analyze modified Python files
        id: analysis
        run: |
          python scripts/github_actions_runner.py
        continue-on-error: true
      
      # Commenter la Pull Request avec les rÃ©sultats
      - name: ğŸ’¬ Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const reportPath = 'quality_report.json';
            
            if (fs.existsSync(reportPath)) {
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              
              const body = `
              ## ğŸ›¡ï¸ Quality Gate Report
              
              **Score:** ${report.score}/100 ${report.score >= 70 ? 'âœ…' : 'âŒ'}
              **Status:** ${report.status}
              
              ### ğŸ“Š Statistics
              - âŒ Critiques: ${report.critiques}
              - âš ï¸ Warnings: ${report.warnings}
              - â„¹ï¸ Infos: ${report.infos}
              
              ### ğŸ”§ By Tool
              - ğŸ“ Flake8: ${report.flake8}
              - ğŸ”’ Bandit: ${report.bandit}
              - ğŸ¤– OpenAI: ${report.openai}
              
              ${report.score < 70 ? 'âš ï¸ **Action Required:** Please fix the issues before merging.' : 'âœ… Code quality is acceptable!'}
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }
      
      # Bloquer le merge si le score est trop bas
      - name: â›” Check Quality Gate
        run: |
          if [ -f quality_report.json ]; then
            SCORE=$(python -c "import json; print(json.load(open('quality_report.json'))['score'])")
            echo "Score: $SCORE"
            if [ "$SCORE" -lt 70 ]; then
              echo "âŒ Quality Gate FAILED: Score $SCORE < 70"
              exit 1
            else
              echo "âœ… Quality Gate PASSED: Score $SCORE >= 70"
            fi
          else
            echo "âš ï¸ No quality report found"
            exit 1
          fi

  # ==========================================
  # JOB 3: GÃ©nÃ©ration du Badge de QualitÃ©
  # ==========================================
  generate-badge:
    name: Generate Quality Badge
    runs-on: ubuntu-latest
    needs: quality-gate-analysis
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ… Create Quality Badge
        uses: schneegans/dynamic-badges-action@v1.6.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: your-gist-id-here
          filename: quality-badge.json
          label: Quality
          message: 85/100
          color: green
